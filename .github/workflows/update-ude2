name: Update UDE Name2 (OIDC, no secrets)

on:
  workflow_dispatch:

permissions:
  id-token: write   # required for GitHub OIDC
  contents: read

jobs:
  update-ude:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Authenticate to Azure using OIDC (no client secret in GitHub)
      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          tenant-id:       ${{ secrets.AZURE_TENANT_ID }}
          client-id:       ${{ secrets.AZURE_CLIENT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Define the environments to rename (hard-coded here)
      # Use GUIDs if you have them; you can also use unique names or display names.
      - name: Define rename list
        id: matrix
        shell: bash
        run: |
          # --- BEGIN HARD-CODED LIST ---
          # Each line: ENV_IDENTIFIER|NEW_DISPLAY_NAME
          cat > renames.txt <<'MAP'
          8d996ece-8558-4c4e-b459-a51b3beafdb4|UDE Development - India
          5a41a3c1-7c2a-4d7b-86b7-40b5d10d1e77|UDE Test - India
          # ude-stage01|UDE Staging - India   # (example using unique name)
          MAP
          echo "Created renames.txt:"
          cat renames.txt

      # Start the Automation Runbook once per mapping (fire-and-wait)
      - name: Trigger runbook for each rename
        id: trigger
        uses: azure/CLI@v2
        with:
          azcliversion: 2.57.0
          inlineScript: |
            set -euo pipefail
            RG="${{ secrets.AUTOMATION_RG }}"
            AA="${{ secrets.AUTOMATION_ACCOUNT }}"
            RUNBOOK="Rename-UDE-DisplayName"

            declare -a JOBS=()
            while IFS='|' read -r ENV_ID_OR_NAME NEW_NAME; do
              [[ -z "$ENV_ID_OR_NAME" || "$ENV_ID_OR_NAME" =~ ^# ]] && continue
              echo "Starting runbook for: $ENV_ID_OR_NAME -> $NEW_NAME"
              JOB_ID=$(az automation runbook start \
                --resource-group "$RG" \
                --automation-account-name "$AA" \
                --name "$RUNBOOK" \
                --parameters environmentIdOrName="$ENV_ID_OR_NAME" newDisplayName="$NEW_NAME" \
                --query jobId -o tsv)
              echo "Job started: $JOB_ID"
              JOBS+=("$JOB_ID")
            done < renames.txt

            printf "%s\n" "${JOBS[@]}" > jobs.txt
            echo "Started ${#JOBS[@]} job(s)."
      
      # Optionally wait for all jobs to complete
      - name: Wait for completion
        if: always()
        uses: azure/CLI@v2
        with:
          azcliversion: 2.57.0
          inlineScript: |
            set -euo pipefail
            RG="${{ secrets.AUTOMATION_RG }}"
            AA="${{ secrets.AUTOMATION_ACCOUNT }}"
            FAIL=0
            while read -r JOB_ID; do
              echo "Polling $JOB_ID ..."
              for i in {1..40}; do
                STATUS=$(az automation job show -g "$RG" -n "$JOB_ID" --automation-account-name "$AA" --query status -o tsv)
                echo "  $(date -u +%T) -> $STATUS"
                case "$STATUS" in
                  Completed) break ;;
                  Failed|Stopped|Suspended) FAIL=1; break ;;
                esac
                sleep 15
              done
            done < jobs.txt
            exit $FAIL
