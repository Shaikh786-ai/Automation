name: Copy Data Between Existing Environments (OIDC, no secrets)

on:
  workflow_dispatch:
    inputs:
      SOURCE_ENV_ID:
        description: "Source environment ID (GUID)"
        required: true
      TARGET_ENV_ID:
        description: "Target environment ID (GUID)"
        required: true
      WAIT_MINUTES:
        description: "Max async wait time (minutes)"
        required: true
        default: "240"

permissions:
  id-token: write      # Required for OIDC
  contents: read

jobs:
  copy-db:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Install PAC CLI
      - uses: microsoft/powerplatform-actions/actions-install@v1

      # Authenticate using OIDC with App Registration
      - name: Authenticate (OIDC)
        uses: microsoft/powerplatform-actions/who-am-i@v1
        with:
          app-id:    ${{ secrets.PP_CLIENT_ID }}
          tenant-id: ${{ secrets.PP_TENANT_ID }}

      # Use PAC CLI directly to copy DB from existing source -> existing target
      - name: Copy Dataverse Database (source -> target)
        run: |
          echo "Copying DB from ${{ github.event.inputs.SOURCE_ENV_ID }} to ${{ github.event.inputs.TARGET_ENV_ID }}"

          pac admin copy-database \
            --source-env  "${{ github.event.inputs.SOURCE_ENV_ID }}" \
            --target-env  "${{ github.event.inputs.TARGET_ENV_ID }}" \
            --async false \
            --max-async-wait-time "${{ github.event.inputs.WAIT_MINUTES }}"
          
          echo "Database copy job submitted."

      - name: Done
        run: echo "Copy completed (or running async)."
