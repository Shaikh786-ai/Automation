name: Install CE Applications (Field Service & Sales)

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/applications.json"

jobs:
  install-ce-apps:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Power Platform CLI
        uses: microsoft/powerplatform-actions/actions-install@v1

      - name: Authenticate to Power Platform
        uses: microsoft/powerplatform-actions/actions-authenticate@v1
        with:
          username: ${{ secrets.PP_USERNAME }}
          password: ${{ secrets.PP_PASSWORD }}
          tenant-id: ${{ secrets.PP_TENANT_ID }}

      - name: Select Power Platform Environment
        shell: pwsh
        run: |
          pac org select --url "${{ secrets.PP_ENVIRONMENT_URL }}"

      - name: Install CE Applications from applications.json
        shell: pwsh
        run: |
          $apps = Get-Content ".github/workflows/applications.json" | ConvertFrom-Json
          $environmentUrl = "${{ secrets.PP_ENVIRONMENT_URL }}"

          foreach ($app in $apps) {
            Write-Host "Installing application: $($app.FriendlyName)"

            pac admin assign-application `
              --environment $environmentUrl `
              --application-name $app.UniqueName
          }
