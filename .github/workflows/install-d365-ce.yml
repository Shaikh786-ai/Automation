name: Install D365 CE Applications (Federated - GitHub Automation)

on:
  workflow_dispatch:
  push:
    branches:
      - main

# REQUIRED for OIDC / Federated Credentials
permissions:
  id-token: write
  contents: read

jobs:
  install-ce-applications:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Power Platform CLI
        uses: microsoft/powerplatform-actions/actions-install@v1

      - name: Authenticate using Federated Credentials
        uses: microsoft/powerplatform-actions/actions-auth@v1
        with:
          tenant-id: ${{ secrets.POWERPLATFORM_TENANT_ID }}
          client-id: ${{ secrets.POWERPLATFORM_CLIENT_ID }}
          federated-credential: true

      - name: Install CE Applications from MyApps.json
        shell: pwsh
        run: |
          Write-Host "Loading CE application configuration..."

          $configPath = "MyApps.json"
          if (!(Test-Path $configPath)) {
            throw "MyApps.json not found at repository root."
          }

          $config = Get-Content $configPath | ConvertFrom-Json
          $environmentUrl = $config.environmentUrl
          $applications = $config.applications

          if (-not $environmentUrl) {
            throw "environmentUrl is missing in MyApps.json"
          }

          Write-Host "Target Power Platform Environment:"
          Write-Host $environmentUrl

          foreach ($app in $applications) {
            if (-not $app.appId) {
              Write-Warning "Skipping application entry with missing appId."
              continue
            }

            Write-Host "Triggering installation for CE AppId: $($app.appId)"

            pac admin install-application `
              --environment $environmentUrl `
              --application-id $app.appId `
              --async
          }

      - name: Clear Power Platform authentication
        run: pac auth clear
