name: Copy Dataverse DB (Existing → Existing) — OIDC, no secrets

on:
  workflow_dispatch:
    inputs:
      SOURCE_ENV_ID:
        description: "Source environment ID (GUID)"
        required: true
      TARGET_ENV_ID:
        description: "Target environment ID (GUID)"
        required: true
      WAIT_MINUTES:
        description: "Max async wait time (minutes)"
        required: true
        default: "240"

permissions:
  id-token: write   # required for GitHub OIDC
  contents: read

jobs:
  copy-db:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Install PAC CLI on the runner
      - uses: microsoft/powerplatform-actions/actions-install@v1
      # The official repo provides this installer and documents supported actions. [2](https://learn.microsoft.com/en-us/powershell/module/microsoft.powerapps.administration.powershell/?view=pa-ps-latest)

      # Authenticate in ADMIN context using GitHub Federation (OIDC)
      - name: PAC auth (OIDC, admin context)
        run: |
          pac auth clear
          pac auth create \
            --tenant        "${{ secrets.PP_TENANT_ID }}" \
            --applicationId "${{ secrets.PP_CLIENT_ID }}" \
            --githubFederated
        # Authenticate once, tenant-wide, no environment argument needed for admin ops. 
        # Admin operations are executed via 'pac admin ...' commands. [1](https://alyaconsulting.ch/Solutions/Microsoft.PowerApps.Administration.PowerShell/Add-PowerAppsAccount)

      # Copy the Dataverse database from source -> target
      - name: Copy Dataverse database (source → target)
        run: |
          pac admin copy-database \
            --source-env "${{ github.event.inputs.SOURCE_ENV_ID }}" \
            --target-env "${{ github.event.inputs.TARGET_ENV_ID }}" \
            --async false \
            --max-async-wait-time "${{ github.event.inputs.WAIT_MINUTES }}"
        # 'copy-database' is part of the 'pac admin' command set for environment admin tasks. [1](https://alyaconsulting.ch/Solutions/Microsoft.PowerApps.Administration.PowerShell/Add-PowerAppsAccount)

      - name: Done
        run: echo "Database copy submitted/completed."
