name: Rename Environment Display Name

on:
  workflow_dispatch:
    inputs:
      ENVIRONMENT_ID:
        description: "Environment ID (GUID)"
        required: true
      NEW_DISPLAY_NAME:
        description: "New friendly name"
        required: true

permissions:
  contents: read

jobs:
  rename-env:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Power Platform Admin Module
        shell: pwsh
        run: |
          Set-PSRepository -Name "PSGallery" -InstallationPolicy Trusted
          Install-Module Microsoft.PowerApps.Administration.PowerShell -Force -AllowClobber
          Import-Module  Microsoft.PowerApps.Administration.PowerShell -Force

      - name: Login using Service Principal (Admin PowerShell)
        shell: pwsh
        run: |
          $tenantId = "${{ secrets.PP_TENANT_ID }}"
          $appId    = "${{ secrets.PP_CLIENT_ID }}"
          $secret   = "${{ secrets.PP_CLIENT_SECRET }}" | ConvertTo-SecureString -AsPlainText -Force
          $cred     = New-Object System.Management.Automation.PSCredential ($appId, $secret)

          # Official SPN login
          Add-PowerAppsAccount -TenantId $tenantId -ApplicationId $appId -ClientSecret $secret

      - name: Rename Environment
        shell: pwsh
        run: |
          $envId   = "${{ github.event.inputs.ENVIRONMENT_ID }}"
          $newName = "${{ github.event.inputs.NEW_DISPLAY_NAME }}"

          # Microsoft-official cmdlet to rename display name
          Set-AdminPowerAppEnvironmentDisplayName `
            -EnvironmentName $envId `
            -NewDisplayName  $newName

          Write-Host "Display name updated successfully."

      - name: Verify Rename
        shell: pwsh
        run: |
          $envId   = "${{ github.event.inputs.ENVIRONMENT_ID }}"
          $info = Get-AdminPowerAppEnvironment -EnvironmentName $envId
          $info | Select-Object DisplayName, EnvironmentName, Location, EnvironmentSku | Format-List
