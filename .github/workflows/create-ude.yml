name: Create UDE (OIDC, no secrets)

on:
  workflow_dispatch:

permissions:
  id-token: write   # required for OIDC
  contents: read

jobs:
  create-ude:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Install the official Power Platform actions (PAC CLI wrapper)
      - uses: microsoft/powerplatform-actions/actions-install@v1

      # Create environment via OIDC (no client secret needed)
      - name: Create UDE environment
        uses: microsoft/powerplatform-actions/create-environment@v1
        with:
          app-id:    ${{ secrets.PP_CLIENT_ID }}   # your Entra App (client) ID
          tenant-id: ${{ secrets.PP_TENANT_ID }}   # your Entra tenant ID
          environment-type: Sandbox
          region: india                # change if needed
          currency: USD
          language: en-US
          domain-name: ude-dev01
          display-name: ude-dev01
          templates: D365_FinOps_Finance
          template-metadata-json: |
            {
              "PostProvisioningPackages": [
                {
                  "applicationUniqueName": "msdyn_FinanceAndOperationsProvisioningAppAnchor",
                  "parameters": "DevToolsEnabled=true|DemoDataEnabled=true"
                }
              ]
            }
