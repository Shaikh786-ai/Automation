name: Rename Environment Display Name (PowerShell)

on:
  workflow_dispatch:
    inputs:
      ENVIRONMENT_ID:
        description: "Environment ID (GUID)"
        required: true
      NEW_DISPLAY_NAME:
        description: "New friendly/display name for the environment"
        required: true

permissions:
  contents: read

jobs:
  rename-display-name:
    runs-on: windows-latest

    steps:
      - name: Checkout (optional)
        uses: actions/checkout@v4

      - name: Install Power Apps Admin PowerShell module
        shell: pwsh
        run: |
          Set-PSRepository -Name "PSGallery" -InstallationPolicy Trusted
          Install-Module Microsoft.PowerApps.Administration.PowerShell -Force -AllowClobber
          Import-Module  Microsoft.PowerApps.Administration.PowerShell -Force

      # Authenticate with Service Principal (Admin module does NOT support GitHub OIDC)
      - name: Connect (Service Principal)
        shell: pwsh
        run: |
          $tenantId = "${{ secrets.PP_TENANT_ID }}"
          $appId    = "${{ secrets.PP_CLIENT_ID }}"
          $secret   = "${{ secrets.PP_CLIENT_SECRET }}" | ConvertTo-SecureString -AsPlainText -Force
          $cred     = New-Object System.Management.Automation.PSCredential ($appId, $secret)

          # Connect to Admin endpoint with SPN
          Connect-AdminPowerAppEnvironment -TenantId $tenantId -Credential $cred

          # Optional: show current user to validate connection
          Write-Host "Connected. SPN: $appId Tenant: $tenantId"

      - name: Rename environment display name
        shell: pwsh
        run: |
          $envId   = "${{ github.event.inputs.ENVIRONMENT_ID }}"
          $newName = "${{ github.event.inputs.NEW_DISPLAY_NAME }}"

          # Perform the rename
          Set-AdminPowerAppEnvironmentDisplayName `
            -EnvironmentName $envId `
            -NewDisplayName  $newName

          Write-Host "Requested rename of environment $envId to '$newName'."

      - name: Verify (list envs & filter)
        shell: pwsh
        run: |
          # Simple verification that shows current DisplayName for the target env
          $envId   = "${{ github.event.inputs.ENVIRONMENT_ID }}"
          $envInfo = Get-AdminPowerAppEnvironment -EnvironmentName $envId
          $envInfo | Select-Object DisplayName, EnvironmentName, Location, EnvironmentType | Format-List
