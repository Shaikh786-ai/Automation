name: Copy Dataverse DB (Existing → Existing) — OIDC, no secrets

on:
  workflow_dispatch:
    inputs:
      SOURCE_ENV_ID:
        description: "Source environment ID (GUID)"
        required: true
      TARGET_ENV_ID:
        description: "Target environment ID (GUID)"
        required: true
      WAIT_MINUTES:
        description: "Max async wait time (minutes)"
        required: true
        default: "240"

permissions:
  id-token: write   # required for GitHub OIDC
  contents: read

jobs:
  copy-db:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Install Power Platform CLI (PAC) - reliable method
      - name: Install Power Platform CLI
        run: |
          dotnet tool install --global Microsoft.PowerApps.CLI.Tool
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      # (Optional but recommended) Verify PAC installation
      - name: Verify PAC CLI
        run: |
          which pac
          pac --version

      # Authenticate in ADMIN context using GitHub Federation (OIDC)
      - name: PAC auth (OIDC, admin context)
        run: |
          pac auth clear
          pac auth create \
            --tenant "${{ secrets.PP_TENANT_ID }}" \
            --applicationId "${{ secrets.PP_CLIENT_ID }}" \
            --githubFederated

      # Copy the Dataverse database from source -> target
      - name: Copy Dataverse database (source → target)
        run: |
          pac admin copy-database \
            --source-env "${{ github.event.inputs.SOURCE_ENV_ID }}" \
            --target-env "${{ github.event.inputs.TARGET_ENV_ID }}" \
            --async false \
            --max-async-wait-time "${{ github.event.inputs.WAIT_MINUTES }}"

      - name: Done
        run: echo "Database copy submitted/completed."
