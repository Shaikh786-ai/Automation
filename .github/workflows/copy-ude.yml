name: Copy Dataverse DB (Existing → Existing) — OIDC, no secrets

on:
  workflow_dispatch:
    inputs:
      SOURCE_ENV_ID:
        description: "Source environment ID (GUID)"
        required: true
      TARGET_ENV_ID:
        description: "Target environment ID (GUID)"
        required: true
      COPY_TYPE:
        description: "FullCopy (with data) or MinimalCopy (schema only)"
        required: true
        default: "FullCopy"
      WAIT_MINUTES:
        description: "Max async wait time (minutes)"
        required: true
        default: "240"

permissions:
  id-token: write
  contents: read

jobs:
  copy-db:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Recommended by Microsoft to provision PAC on a runner
      - name: Install Power Platform CLI
        uses: microsoft/powerplatform-actions/actions-install@v1

      # Verify PAC availability; if missing, install via .NET global tool and export path.
      - name: Verify PAC presence (and fallback install)
        shell: bash
        run: |
          set -euo pipefail
          echo "PATH before: $PATH"
          if ! command -v pac >/dev/null 2>&1; then
            echo "PAC not found after actions-install. Installing via dotnet global tool..."
            dotnet tool install -g Microsoft.PowerApps.CLI.Tool
            echo "$HOME/.dotnet/tools" >> "$GITHUB_PATH"
          fi
          echo "PATH after: $PATH"
          # Use 'pac help' (not '--version') to avoid parser differences
          pac help >/dev/null

      # Authenticate using OIDC (no client secrets)
      - name: PAC auth (OIDC, admin context)
        shell: bash
        run: |
          set -euo pipefail
          pac auth clear || true
          pac auth create \
            --tenant        "${{ secrets.PP_TENANT_ID }}" \
            --applicationId "${{ secrets.PP_CLIENT_ID }}" \
            --githubFederated
          pac auth who

      # Copy from source → target; correct subcommand is 'pac admin copy'
      - name: Copy Dataverse database (source → target)
        shell: bash
        run: |
          set -euo pipefail
          case "${{ github.event.inputs.COPY_TYPE }}" in
            FullCopy|MinimalCopy) ;;
            *) echo "Invalid COPY_TYPE. Use 'FullCopy' or 'MinimalCopy'." && exit 2 ;;
          esac

          pac admin copy \
            --name "DataverseCopyJob" \
            --source-env "${{ github.event.inputs.SOURCE_ENV_ID }}" \
            --target-env "${{ github.event.inputs.TARGET_ENV_ID }}" \
            --type       "${{ github.event.inputs.COPY_TYPE }}" \
            --async      false \
            --max-async-wait-time "${{ github.event.inputs.WAIT_MINUTES }}"

      - name: Done
        run: echo "Database copy submitted/completed."
